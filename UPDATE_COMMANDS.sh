#!/bin/bash

echo "üìã –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±–æ—Ç–∞ SOINTERA –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ"
echo "========================================"

# 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å
echo ""
echo "1Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–∫–∞–ª—å–Ω—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π..."
git status

echo ""
echo "2Ô∏è‚É£ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ª–æ–∫–∞–ª—å–Ω—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π (–µ—Å–ª–∏ –µ—Å—Ç—å)..."
git stash

echo ""
echo "3Ô∏è‚É£ –ü—Ä–∏–Ω—è—Ç–∏–µ –≤—Å–µ—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π –∏–∑ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è..."
git config pull.rebase false
git pull origin main --allow-unrelated-histories

# –ï—Å–ª–∏ –≤—Å—ë –µ—â—ë –µ—Å—Ç—å –ø—Ä–æ–±–ª–µ–º—ã, —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –∫ –≤–µ—Ä—Å–∏–∏ –∏–∑ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
if [ $? -ne 0 ]; then
    echo ""
    echo "‚ö†Ô∏è –ï—Å—Ç—å –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã. –ü—Ä–∏–Ω–∏–º–∞–µ–º –≤–µ—Ä—Å–∏—é –∏–∑ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è..."
    git reset --hard origin/main
fi

echo ""
echo "4Ô∏è‚É£ –£—Å—Ç–∞–Ω–æ–≤–∫–∞/–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π..."
bun install

echo ""
echo "5Ô∏è‚É£ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –∫—É—Ä—Å–æ–≤..."
echo "‚ö†Ô∏è –í–ù–ò–ú–ê–ù–ò–ï: –≠—Ç–æ –ø–µ—Ä–µ–∑–∞–ø–∏—à–µ—Ç –≤—Å–µ –∫—É—Ä—Å—ã!"
read -p "–û–±–Ω–æ–≤–∏—Ç—å –±–∞–∑—É –∫—É—Ä—Å–æ–≤? (y/n): " -n 1 -r
echo
if [[ $REPLY =~ ^[Yy]$ ]]; then
    bun run update-all-courses-final.js
    echo "‚úÖ –ë–∞–∑–∞ –∫—É—Ä—Å–æ–≤ –æ–±–Ω–æ–≤–ª–µ–Ω–∞"
else
    echo "‚è≠Ô∏è –ü—Ä–æ–ø—É—â–µ–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±–∞–∑—ã –∫—É—Ä—Å–æ–≤"
fi

echo ""
echo "6Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏..."
if [ -f .env ]; then
    echo "‚úÖ –§–∞–π–ª .env –Ω–∞–π–¥–µ–Ω"
    echo "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –≤—Å–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –Ω–∞ –º–µ—Å—Ç–µ:"
    echo "- TELEGRAM_BOT_TOKEN"
    echo "- API_ID"
    echo "- API_HASH"
    echo "- PHONE_NUMBER"
    echo "- OPENAI_API_KEY"
else
    echo "‚ùå –§–∞–π–ª .env –Ω–µ –Ω–∞–π–¥–µ–Ω!"
    echo "–°–∫–æ–ø–∏—Ä—É–π—Ç–µ –∏–∑ –±—ç–∫–∞–ø–∞ –∏–ª–∏ —Å–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—ã–π"
fi

echo ""
echo "7Ô∏è‚É£ –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞..."
pm2 start sointera-sales

echo ""
echo "8Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤..."
pm2 logs sointera-sales --lines 20

echo ""
echo "========================================"
echo "‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!"
echo ""
echo "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ:"
echo "1. –û—Ç–ø—Ä–∞–≤—å—Ç–µ –±–æ—Ç—É —Å–æ–æ–±—â–µ–Ω–∏–µ '–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ'"
echo "2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏: pm2 logs sointera-sales"
echo "3. –ü—Ä–∏ –ø—Ä–æ–±–ª–µ–º–∞—Ö: pm2 restart sointera-sales"
echo ""
echo "–í–µ—Ä—Å–∏—è –±–æ—Ç–∞: 13 (—Å FAQ –∏ —Ä–∞–±–æ—Ç–æ–π —Å –≤–æ–∑—Ä–∞–∂–µ–Ω–∏—è–º–∏)"
